image: golang:latest

stages:
  - provision
  - build
  - deploy

terraform:
  stage: provision
  image: hashicorp/terraform:1.6.6
  script:
    - cd terraform
    - terraform init
    - GOOGLE_APPLICATION_CREDENTIALS=$GCP_SERVICE_ACCOUNT_KEY terraform apply -auto-approve
    - export GCP_BUCKET_NAME=$(terraform output -raw gcp_bucket_name)
    - export GCP_PROJECT_ID=$(terraform output -raw gcp_project_id)
    - export GCP_ZONE=${terraform output -raw gcp_zone}

compile:
  stage: build
  script:
    - cd backend
    - go build -o app ./cmd/main.go

deploy:
  stage: deploy
  image: google/cloud-sdk:latest
  script:
    - gcloud auth activate-service-account --key-file="$GCP_SERVICE_ACCOUNT_KEY"
    - gcloud config set project $GCP_PROJECT_ID
    - ./deploy.sh
  environment: production
