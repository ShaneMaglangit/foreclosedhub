image: golang:latest

stages:
  - provision
  - build
  - deploy

before_script:
  - apt-get update && apt-get install -y wget unzip
  - wget https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip
  - unzip -o terraform_1.6.6_linux_amd64.zip -d /usr/local/bin/
  - terraform -version

terraform:
  stage: provision
  script:
    - cat $GCP_SERVICE_ACCOUNT_KEY
    - gcloud auth activate-service-account --key-file="$GCP_SERVICE_ACCOUNT_KEY"
    - cd terraform
    - terraform init
    - terraform apply -auto-approve
    - export DATABASE_URL=$(terraform output -raw neon_connection_uri)
    - export GCP_BUCKET_NAME=$(terraform output -raw gcp_bucket_name)
    - export GCP_PROJECT_ID=$(terraform output -raw gcp_project_id)
    - export GCP_ZONE=${terraform output -raw gcp_zone}

compile:
  stage: build
  script:
    - cd backend
    - go build -o app ./cmd/main.go

deploy:
  stage: deploy
  image: google/cloud-sdk:latest
  script:
    - gcloud auth activate-service-account --key-file="$GCP_SERVICE_ACCOUNT_KEY"
    - gcloud config set project $GCP_PROJECT_ID
    - ./deploy.sh
  environment: production
