include:
  - component: gitlab.com/components/opentofu/validate-plan@2.0.0-rc1
    inputs:
      version: 2.0.0-rc1
      opentofu_version: 1.9.0
      root_dir: opentofu
  - component: gitlab.com/components/opentofu/job-templates@2.0.0-rc1
    inputs:
      version: 2.0.0-rc1
      opentofu_version: 1.9.0
      root_dir: opentofu

stages:
  - validate
  - build
  - plan
  - apply
  - deploy

apply:
  extends: [ .opentofu:apply ]
  rules: [ { when: on_success } ]

deploy_web:
  stage: deploy
  image: node:23.10.0
  needs:
    - job: apply
  script:
    - npm install --global vercel
    - vercel --cwd web
    - vercel link --yes -project foreclosedhub --token=$TF_VAR_vercel_token
    - vercel pull --yes --environment=production --token=$TF_VAR_vercel_token
    - vercel build --prod --token=$TF_VAR_vercel_token
    - vercel deploy --prebuilt --prod --token=$TF_VAR_vercel_token